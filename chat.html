<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Julie - Serial Chilleuse</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%; background: #f2f2f7;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
    }
    body { display: flex; flex-direction: column; }
    /* Common onboarding overlay */
    .onboard-step {
      position: fixed; inset: 0;
      background: rgba(255,255,255,0.95);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      text-align: center;
      z-index: 100;
      padding: 20px;
    }
    .onboard-step img { width: 120px; margin-bottom: 16px; }
    .onboard-step h2 { font-size: 24px; margin-bottom: 8px; color: #333; }
    .onboard-step p { font-size: 16px; color: #555; line-height: 1.4; margin-bottom: 24px; }
    .btn-primary { background: #7f5af0; color: #fff; padding: 12px 24px; border-radius: 24px; border: none; cursor: pointer; }

    /* Language selection is also an onboard-step */
    .language-selection { background: rgba(96, 192, 230, 0.95); color: #fff; }
    .language-selection p { font-size: 18px; margin-bottom: 16px; }
    .language-selection button { margin: 4px; padding: 8px 16px; font-size: 14px; border: none; border-radius: 8px; cursor: pointer; background: #7f5af0; color: #fff; transition: background 0.2s; }
    .language-selection button:hover { background: #6248c2; }

    /* CTA selection */
    .cta-options { display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px; }
    .cta-options button { padding: 12px; border: none; border-radius: 20px; background: #7f5af0; color: #fff; font-size: 14px; cursor: pointer; }
    .cta-options button:hover { background: #6248c2; }
    .skip-btn { background: transparent; color: #7f5af0; margin-top: 12px; font-size: 14px; cursor: pointer; }

    /* Services carousel */
    .services-carousel { position: relative; display: none; align-items: center; padding: 8px 0; background: #fff; }
    .cards-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 12px; padding: 0 40px; }
    .service-card {
      flex: 0 0 120px;
      background: #fff; border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 12px; text-align: center;
      scroll-snap-align: start;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    .service-card:hover, .service-card:focus {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .service-icon { width: 48px; height: 48px; margin-bottom: 8px; }
    .service-title { display: block; font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .service-sub { display: block; font-size: 12px; color: #666; }
    .nav-arrow {
      background: rgba(255,255,255,0.8); border: none;
      font-size: 24px; width: 32px; height: 32px;
      border-radius: 50%; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      position: absolute;
      top: 50%; transform: translateY(-50%);
      z-index: 10;
    }
    .nav-arrow.left { left: 8px; }
    .nav-arrow.right { right: 8px; }

    /* Chat UI */
    .chat-header { background: #7f5af0; color: #fff; padding: 16px; text-align: center; font-size: 18px; font-weight: bold; flex-shrink: 0; }
    .chat-scroll { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 10px; }
    .message-wrapper { display: flex; align-items: flex-end; gap: 8px; }
    .message { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; word-break: break-word; animation: fadeIn 0.2s ease-in; }
    .user { background: #007aff; color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; border-top-left-radius: 18px; }
    .bot { background: #e5e5ea; color: #000; align-self: flex-start; border-bottom-left-radius: 4px; border-top-right-radius: 18px; }
    .bot-pic { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
    .input-area { background: #fff; padding: 10px; border-top: 1px solid #ccc; display: flex; align-items: center; flex-shrink: 0; }
    .input-area input { flex: 1; padding: 10px 14px; border: 1px solid #ccc; border-radius: 20px; font-size: 16px; outline: none; }
    .input-area button { background: #7f5af0; border: none; border-radius: 50%; width: 40px; height: 40px; margin-left: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .input-area button svg { fill: #fff; width: 24px; height: 24px; }
    .typing { font-style: italic; font-size: 13px; color: #999; margin-left: 8px; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <!-- Onboarding Steps -->
  <div class="onboard-step language-selection" id="step-language">
    <p>Choisissez votre langue</p>
    <button class="lang-btn" data-lang="fr">FranÃ§ais</button>
    <button class="lang-btn" data-lang="en">English</button>
    <button class="lang-btn" data-lang="es">EspaÃ±ol</button>
    <button class="lang-btn" data-lang="de">Deutsch</button>
  </div>
  <div class="onboard-step" id="step-intro" style="display:none;">
    <img src="image1.png" alt="Julie qui vous sourit">
    <h2>Bienvenue !</h2>
    <p>Je suis <strong>Julie</strong>, votre concierge virtuelle pour votre sÃ©jour.<br>
       Services, livret, bons plans locaux : je mâ€™occupe de tout.</p>
    <button class="btn-primary" id="btn-intro-next">CoolÂ !</button>
  </div>
  <div class="onboard-step" id="step-cta" style="display:none;">
    <h2>Par oÃ¹ commencer ?</h2>
    <div class="cta-options">
      <button data-cta="show-services">Les services de mon hÃ´tel</button>
      <button data-cta="Le livret d'accueil de ma chambre">Le livret d'accueil de ma chambre</button>
      <button data-cta="OÃ¹ chiller local ?">OÃ¹ chiller local ?</button>
    </div>
    <button class="skip-btn" id="btn-cta-skip">Viens chatter</button>
  </div>

  <!-- Chat and Services -->
  <div class="chat-header">ðŸ’¬ Julie - Serial Chilleuse</div>
  <div class="services-carousel" id="services-carousel">
    <button class="nav-arrow left" aria-label="PrÃ©cÃ©dent">â€¹</button>
    <div class="cards-container">
      <div class="service-card" data-service="Room Service">
        <img src="icons/room-service.svg" alt="Room Service" class="service-icon">
        <span class="service-title">Room Service</span>
        <small class="service-sub">Commander un repas</small>
      </div>
      <div class="service-card" data-service="MÃ©nage">
        <img src="icons/housekeeping.svg" alt="MÃ©nage" class="service-icon">
        <span class="service-title">MÃ©nage</span>
        <small class="service-sub">Demande de nettoyage</small>
      </div>
      <div class="service-card" data-service="Blanchisserie">
        <img src="icons/laundry.svg" alt="Blanchisserie" class="service-icon">
        <span class="service-title">Blanchisserie</span>
        <small class="service-sub">Envoyer du linge</small>
      </div>
      <div class="service-card" data-service="Spa & Bien-Ãªtre">
        <img src="icons/spa.svg" alt="Spa & Bien-Ãªtre" class="service-icon">
        <span class="service-title">Spa & Bien-Ãªtre</span>
        <small class="service-sub">RÃ©server un soin</small>
      </div>
    </div>
    <button class="nav-arrow right" aria-label="Suivant">â€º</button>
  </div>

  <div class="chat-scroll" id="chat"></div>
  <div class="input-area">
    <input type="text" id="user-input" placeholder="Ã‰cris ton message ici...">
    <button onclick="sendMessage()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3v7l15 2-15 2z"/></svg></button>
  </div>

  <script>
    // Map link & linkify
    function generateMapLink(text) {
      const regex = /situÃ©(?:s)? au ([^\.]+)/i;
      const match = regex.exec(text);
      if (match && match[1]) {
        return `<a href="https://maps.google.com/?q=${encodeURIComponent(match[1].trim())}" target="_blank">c'est par ici</a>`;
      }
      return `<a href="https://maps.google.com" target="_blank">c'est par ici</a>`;
    }
    function linkify(text) {
      if (text.includes("c'est par ici")) text = text.replace("c'est par ici", generateMapLink(text));
      return text.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig, '<a href="$1" target="_blank">$1</a>');
    }

    // Chat functions
    let selectedLanguage = 'fr';
    const languageTexts = {
      fr: { placeholder: "Ã‰cris ton message ici...", typing: "Julie est en train de rÃ©pondre..." },
      en: { placeholder: "Type your message here...", typing: "Julie is typing..." },
      es: { placeholder: "Escribe tu mensaje aquÃ­...", typing: "Julie estÃ¡ respondiendo..." },
      de: { placeholder: "Schreib deine Nachricht hier...", typing: "Julie antwortet gerade..." }
    };
    function updatePlaceholder() { document.getElementById('user-input').placeholder = languageTexts[selectedLanguage].placeholder; }
    function addMessage(content, sender) {
      const clean = content.replace(/\*\*/g,'').replace(/\n+/g,' ');
      const html = linkify(clean);
      const wrap = document.createElement('div'); wrap.className='message-wrapper';
      if (sender==='bot') {
        const av = document.createElement('img'); av.src='image.png'; av.alt='Julie'; av.className='bot-pic'; wrap.appendChild(av);
      }
      const msg = document.createElement('div'); msg.className=`message ${sender}`; msg.innerHTML=html;
      wrap.appendChild(msg); document.getElementById('chat').appendChild(wrap);
      document.querySelector('.chat-scroll').scrollTop = document.querySelector('.chat-scroll').scrollHeight;
    }
    function showTyping(){ const t=document.createElement('div'); t.id='typing'; t.className='typing'; t.textContent=languageTexts[selectedLanguage].typing; document.getElementById('chat').appendChild(t); document.querySelector('.chat-scroll').scrollTop=document.querySelector('.chat-scroll').scrollHeight; }
    function removeTyping(){ const t=document.getElementById('typing'); if(t) t.remove(); }
    function sendMessage(){ const inp=document.getElementById('user-input'), txt=inp.value.trim(); if(!txt) return; addMessage(txt,'user'); inp.value=''; showTyping();
      fetch('https://c842-2001-861-2cab-2ce0-70c5-b21f-76d2-20c5.ngrok-free.app/webhook/30e22add-d5d7-461e-ac07-fc95a3843338',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:txt,sessionId:localStorage.getItem('chatSession'),language:selectedLanguage})})
        .then(r=>r.json()).then(data=>{ removeTyping(); addMessage(data.response||(data[0]&&data[0].output)||data.message||"Je n'ai pas compris ðŸ˜…",'bot'); })
        .catch(e=>{ removeTyping(); addMessage("Erreur de connexion ðŸ˜“",'bot'); console.error(e); }); }
    document.getElementById('user-input').addEventListener('keydown',e=>{ if(e.key==='Enter') sendMessage(); });
    const sessionId = localStorage.getItem('chatSession')||crypto.randomUUID(); localStorage.setItem('chatSession',sessionId);

    // Onboarding
    const stepLang = document.getElementById('step-language'), stepIntro = document.getElementById('step-intro'), stepCta = document.getElementById('step-cta');
    function finishOnboarding(){ localStorage.setItem('onboardSeen','true'); [stepLang,stepIntro,stepCta].forEach(s=>s.style.display='none'); updatePlaceholder(); }
    if(localStorage.getItem('onboardSeen')) finishOnboarding(); else stepLang.style.display='flex';
    document.querySelectorAll('.lang-btn').forEach(b=> b.onclick=()=>{ selectedLanguage=b.dataset.lang; stepLang.style.display='none'; stepIntro.style.display='flex'; });
    document.getElementById('btn-intro-next').onclick=()=>{ stepIntro.style.display='none'; stepCta.style.display='flex'; };
    document.querySelectorAll('#step-cta .cta-options button').forEach(b=> b.onclick=()=>{
      const c=b.dataset.cta;
      stepCta.style.display='none';
      finishOnboarding();
      if(c==='show-services') showServices(); else { addMessage(c,'user'); showTyping(); sendCTA(c); }
    });
    document.getElementById('btn-cta-skip').onclick=finishOnboarding;

    // Show services carousel
    function showServices(){ document.getElementById('services-carousel').style.display='flex'; }
    // Carousel navigation
    const cont=document.querySelector('.cards-container');
    document.querySelector('.nav-arrow.left').onclick=()=>cont.scrollBy({ left: -150, behavior: 'smooth' });
    document.querySelector('.nav-arrow.right').onclick=()=>cont.scrollBy({ left: 150, behavior: 'smooth' });
    // Card click
    document.querySelectorAll('.service-card').forEach(card=> card.onclick=()=>{
      const svc=card.dataset.service;
      document.getElementById('services-carousel').style.display='none';
      addMessage(svc,'user'); showTyping(); sendCTA(svc);
    });
    function sendCTA(text){ fetch('https://c842-2001-861-2cab-2ce0-70c5-b21f-76d2-20c5.ngrok-free.app/webhook/30e22add-d5d7-461e-ac07-fc95a3843338',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,sessionId:sessionId,language:selectedLanguage})}) .then(r=>r.json()).then(data=>{ removeTyping(); addMessage(data.response||(data[0]&&data[0].output)||data.message||"Je n'ai pas compris ðŸ˜…",'bot'); }).catch(e=>{ removeTyping(); addMessage("Erreur de connexion ðŸ˜“",'bot'); console.error(e); }); }
  </script>
</body>
</html>
