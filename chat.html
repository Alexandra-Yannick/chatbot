<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Julie - Serial Chilleuse</title>
  <style>
    :root {
      --color-primary: #60C0E6;
      --color-primary-hover: #468FCF;
      --color-bg: #F2F2F7;
      --color-text-dark: #333333;
      --color-text: #555555;
      --font-base: 1rem;
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --radius: 12px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; background: var(--color-bg); font-family: var(--font-family); font-size: var(--font-base); overflow: hidden; }
    body { display: flex; flex-direction: column; }

    /* Skip link for accessibility */
    .skip-link { position: absolute; top: -40px; left: 0; background: #000; color: #fff; padding: 8px; z-index: 200; text-decoration: none; }
    .skip-link:focus { top: 0; }

    /* Screen reader only */
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    :focus-visible { outline: 3px solid var(--color-primary-hover); outline-offset: 2px; }

    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 0s !important; transition-duration: 0s !important; }
    }

    /* Onboarding overlays */
    .onboard-step { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; z-index: 100; padding: 20px; }
    .onboard-step img { width: 120px; margin-bottom: 16px; }
    .onboard-step h2 { font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--color-text-dark); }
    .onboard-step p { font-size: 1rem; color: var(--color-text); line-height: 1.4; margin-bottom: 1.5rem; }
    .btn-primary { background: var(--color-primary); color: #fff; padding: 0.75rem 1.5rem; border-radius: 24px; border: none; cursor: pointer; }
    .btn-primary:hover { background: var(--color-primary-hover); }

    .language-selection { background: rgba(96,192,230,0.95); color: #fff; }
    .language-selection p { font-size: 1.125rem; margin-bottom: 1rem; }
    .language-selection button { margin: 0.25rem; padding: 0.5rem 1rem; font-size: 0.875rem; border: none; border-radius: var(--radius); cursor: pointer; background: var(--color-primary); color: #fff; transition: background 0.2s; }
    .language-selection button:hover { background: var(--color-primary-hover); }

    .cta-options { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem; }
    .cta-options button { padding: 0.75rem; border: none; border-radius: 20px; background: var(--color-primary); color: #fff; font-size: 0.875rem; cursor: pointer; }
    .cta-options button:hover { background: var(--color-primary-hover); }
    .skip-btn { background: transparent; color: var(--color-primary); margin-top: 0.75rem; font-size: 0.875rem; cursor: pointer; }

    /* Header with back button */
    .chat-header { display: flex; align-items: center; justify-content: center; position: relative; background: var(--color-primary); color: #fff; padding: 1rem; font-size: 1.125rem; font-weight: bold; flex-shrink: 0; }
    #header-back-btn { position: absolute; left: 1rem; background: none; border: none; font-size: 1.5rem; color: #fff; cursor: pointer; display: none; }

    /* Services carousel */
    .services-carousel { position: relative; display: none; background: #fff; padding: 0.5rem 0; flex-direction: row; align-items: center; }
    .nav-arrow { background: rgba(255,255,255,0.8); border: none; font-size: 1.25rem; width: 2rem; height: 2rem; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; position: absolute; top: 50%; transform: translateY(-50%); z-index: 10; }
    .nav-arrow.left { left: 1rem; }
    .nav-arrow.right { right: 1rem; }
    .cards-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 0.75rem; padding: 0 2.5rem; }
    .service-card { flex: 0 0 8rem; background: #fff; border-radius: var(--radius); box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 0.75rem; text-align: center; scroll-snap-align: start; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; }
    .service-card:hover, .service-card:focus { transform: translateY(-0.125rem); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .service-card[tabindex] { outline: none; }
    .service-icon { width: 3rem; height: 3rem; margin-bottom: 0.5rem; }
    .service-title { display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem; color: var(--color-text-dark); }
    .service-sub { display: block; font-size: 0.75rem; color: var(--color-text); }

    /* Chat UI */
    .chat-scroll { flex: 1; overflow-y: auto; padding: 0.75rem; display: flex; flex-direction: column; gap: 0.625rem; }
    .message-wrapper { display: flex; align-items: flex-end; gap: 0.5rem; }
    .message { max-width: 75%; padding: 0.625rem 0.875rem; border-radius: var(--radius); font-size: 0.875rem; line-height: 1.4; word-break: break-word; animation: fadeIn 0.2s ease-in; }
    .user { background: #007aff; color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; border-top-left-radius: 18px; }
    .bot { background: #e5e5ea; color: #000; align-self: flex-start; border-bottom-left-radius: 4px; border-top-right-radius: 18px; }
    .bot-pic { width: 2rem; height: 2rem; border-radius: 50%; object-fit: cover; }
    .input-area { background: #fff; padding: 0.625rem; border-top: 1px solid #ccc; display: flex; align-items: center; flex-shrink: 0; }
    .input-area input { flex: 1; padding: 0.625rem 0.875rem; border: 1px solid #ccc; border-radius: 20px; font-size: 1rem; outline: none; }
    .input-area button { background: var(--color-primary); border: none; border-radius: 50%; width: 2.5rem; height: 2.5rem; margin-left: 0.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .input-area button svg { fill: #fff; width: 1.5rem; height: 1.5rem; }
    .typing { font-style: italic; font-size: 0.75rem; color: #999; margin-left: 0.5rem; }

    /* Sending spinner */
    @keyframes ellipsis { 0%{content: '';} 33%{content: '.';} 66%{content: '..';} 100%{content: '...';} }
    button.sending::after { display: inline-block; margin-left: 0.25rem; animation: ellipsis 1s steps(4) infinite; content: ''; }
    button:disabled { opacity: 0.6; cursor: default; }
    input:disabled { background: #e5e5ea; }

    /* Error toast */
    .toast { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%); background: rgba(255,0,0,0.9); color: #fff; padding: 0.5rem 1rem; border-radius: var(--radius); font-size: 0.8125rem; opacity: 0; animation: fadeIn 0.3s forwards, fadeOut 0.3s 3s forwards; }
    @keyframes fadeOut { to { opacity: 0; transform: translate(-50%, 1.25rem); } }

    /* Accessibility status */
    #aria-status { position: absolute; left: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(0.25rem); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <a href="#chat" class="skip-link">Aller au chat</a>
  <!-- ARIA live region -->
  <div id="aria-status" aria-live="polite"></div>

  <!-- Onboarding Steps -->
  <div class="onboard-step language-selection" id="step-language">
    <p>Choisissez votre langue</p>
    <button class="lang-btn" data-lang="fr">Fran√ßais</button>
    <button class="lang-btn" data-lang="en">English</button>
    <button class="lang-btn" data-lang="es">Espa√±ol</button>
    <button class="lang-btn" data-lang="de">Deutsch</button>
  </div>
  <div class="onboard-step" id="step-intro" style="display:none;">
    <img src="image2.png" alt="Julie qui vous sourit">
    <h2>Bienvenue !</h2>
    <p>Je suis <strong>Julie</strong>, votre concierge virtuelle pour votre s√©jour.<br>Services, livret, bons plans locaux : je m‚Äôoccupe de tout.</p>
    <button class="btn-primary" id="btn-intro-next">Cool‚ÄØ!</button>
  </div>
  <div class="onboard-step" id="step-cta" style="display:none;">
    <h2>Par o√π commencer ?</h2>
    <div class="cta-options">
      <button data-cta="show-services">Les services de mon h√¥tel</button>
      <button data-cta="Le livret d'accueil de ma chambre">Le livret d'accueil de ma chambre</button>
      <button data-cta="O√π chiller local ?">O√π chiller local ?</button>
    </div>
    <button class="skip-btn" id="btn-cta-skip">Viens chatter</button>
  </div>

  <!-- Chat header with back button -->
  <div class="chat-header">
    <button id="header-back-btn" aria-label="Retour">‚Äπ</button>
    üí¨ Julie
  </div>

  <!-- Services carousel -->
  <div class="services-carousel" id="services-carousel">
    <button class="nav-arrow left" aria-label="Pr√©c√©dent">‚Äπ</button>
    <div class="cards-container">
      <div class="service-card" data-service="Room Service" tabindex="0" role="button" aria-label="S√©lectionner Room Service">
        <img src="room.png" class="service-icon" alt="Room Service">
        <span class="service-title">Room Service</span>
        <small class="service-sub">Commander un repas</small>
      </div>
      <div class="service-card" data-service="M√©nage" tabindex="0" role="button" aria-label="S√©lectionner M√©nage">
        <img src="menage.png" class="service-icon" alt="M√©nage">
        <span class="service-title">M√©nage</span>
        <small class="service-sub">Demande de nettoyage</small>
      </div>
      <div class="service-card" data-service="Petit-d√©jeuner" tabindex="0" role="button" aria-label="S√©lectionner Petit-d√©jeuner">
        <img src="petit-dejeuner.png" class="service-icon" alt="Petit-d√©jeuner">
        <span class="service-title">Petit-d√©jeuner</span>
        <small class="service-sub">Le Petit-d√©jeuner</small>
      </div>
      <div class="service-card" data-service="Spa & Bien-√™tre" tabindex="0" role="button" aria-label="S√©lectionner Spa & Bien-√™tre">
        <img src="spa.png" class="service-icon" alt="Spa & Bien-√™tre">
        <span class="service-title">Spa & Bien-√™tre</span>
        <small class="service-sub">R√©server un soin</small>
      </div>
    </div>
    <button class="nav-arrow right" aria-label="Suivant">‚Ä∫</button>
  </div>

  <!-- Chat messages -->
  <div class="chat-scroll" id="chat"></div>
  <div class="input-area">
    <label for="user-input" class="sr-only">Message</label>
    <input type="text" id="user-input" placeholder="√âcris ton message ici..." />
    <button id="send-btn"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3v7l15 2-15 2z"/></svg></button>
  </div>

  <script>
    // Dynamic map link and linkify
    function generateMapLink(text) {
      const regex = /situ√©(?:s)? au ([^\.]+)/i;
      const match = regex.exec(text);
      return match && match[1]
        ? `<a href="https://maps.google.com/?q=${encodeURIComponent(match[1].trim())}" target="_blank">c'est par ici</a>`
        : `<a href="https://maps.google.com" target="_blank">c'est par ici</a>`;
    }
    function linkify(text) {
      if (text.includes("c'est par ici")) text = text.replace("c'est par ici", generateMapLink(text));
      return text.replace(/((https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig, '<a href="$1" target="_blank">$1</a>');
    }

    // Chat functions & feedback
    let selectedLanguage = 'fr';
    const languageTexts = {
      fr: { placeholder: "√âcris ton message ici...", typing: "Julie est en train de r√©pondre..." },
      en: { placeholder: "Type your message here...", typing: "Julie is typing..." },
      es: { placeholder: "Escribe tu mensaje aqu√≠...", typing: "Julie est√° respondiendo..." },
      de: { placeholder: "Schreib deine Nachricht hier...", typing: "Julie antwortet gerade..." }
    };
    const inputEl = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const headerBackBtn = document.getElementById('header-back-btn');
    const ariaStatus = document.getElementById('aria-status');
    let sessionId = localStorage.getItem('chatSession') || crypto.randomUUID();
    localStorage.setItem('chatSession', sessionId);

    function updatePlaceholder() { inputEl.placeholder = languageTexts[selectedLanguage].placeholder; }
    function scrollChat() { document.querySelector('.chat-scroll').scrollTop = document.querySelector('.chat-scroll').scrollHeight; }
    function showTyping() {
      const t = document.createElement('div'); t.id='typing'; t.className='typing'; t.textContent = languageTexts[selectedLanguage].typing;
      document.getElementById('chat').appendChild(t);
      scrollChat();
    }
    function removeTyping() { const t = document.getElementById('typing'); if (t) t.remove(); }

    function addMessage(content, sender) {
      const clean = content.replace(/\*\*/g,'').replace(/
+/g,' ');
      const html = linkify(clean);
      const wrap = document.createElement('div'); wrap.className='message-wrapper';
      if (sender==='bot') { const av=document.createElement('img'); av.src='image.png'; av.alt='Julie'; av.className='bot-pic'; wrap.appendChild(av); }
      const msg = document.createElement('div'); msg.className=`message ${sender}`; msg.innerHTML=html; wrap.appendChild(msg);
      document.getElementById('chat').appendChild(wrap);
      ariaStatus.textContent = clean;
      scrollChat();
    }

    function showError(msg) {
      const t = document.createElement('div'); t.className='toast'; t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 4000);
    }

    async function sendMessage() {
      const txt = inputEl.value.trim(); if (!txt) return;
      addMessage(txt,'user'); inputEl.value='';
      showTyping();
      // disable
      inputEl.disabled = true; sendBtn.disabled = true; sendBtn.classList.add('sending');

      try {
        const res = await fetch('https://c842-2001-861-2cab-2ce0-70c5-b21f-76d2-20c5.ngrok-free.app/webhook/30e22add-d5d7-461e-ac07-fc95a3843338', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: txt, sessionId, language: selectedLanguage })
        });
        const data = await res.json();
        removeTyping();
        addMessage(data.response || data.message || "Je n'ai pas compris üòÖ", 'bot');
      } catch (e) {
        removeTyping();
        showError('Probl√®me de connexion, r√©essayez');
      } finally {
        // re-enable
        inputEl.disabled = false; sendBtn.disabled = false; sendBtn.classList.remove('sending');
        inputEl.focus();
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keydown', e => { if (e.key==='Enter') sendMessage(); });

    // Onboarding & navigation
    const stepLang = document.getElementById('step-language');
    const stepIntro = document.getElementById('step-intro');
    const stepCta = document.getElementById('step-cta');
    function showBackBtn() { headerBackBtn.style.display = 'block'; }
    function hideBackBtn() { headerBackBtn.style.display = 'none'; }
    function finishOnboarding() { localStorage.setItem('onboardSeen','true'); [stepLang,stepIntro,stepCta].forEach(s=>s.style.display='none'); hideBackBtn(); updatePlaceholder(); }
    if (localStorage.getItem('onboardSeen')) finishOnboarding(); else stepLang.style.display='flex';
    document.querySelectorAll('.lang-btn').forEach(b=> b.onclick=()=>{ selectedLanguage=b.dataset.lang; stepLang.style.display='none'; stepIntro.style.display='flex'; });
    document.getElementById('btn-intro-next').onclick=()=>{ stepIntro.style.display='none'; stepCta.style.display='flex'; };
    document.querySelectorAll('#step-cta .cta-options button').forEach(b=> b.onclick=()=>{ const c=b.dataset.cta; stepCta.style.display='none'; finishOnboarding(); showBackBtn(); if (c==='show-services') showServices(); else { addMessage(c,'user'); sendMessage(); } });
    document.getElementById('btn-cta-skip').onclick=finishOnboarding;

    // Carousel controls
    function showServices(){ document.getElementById('services-carousel').style.display='flex'; }
    const cont = document.querySelector('.cards-container');
    document.querySelector('.nav-arrow.left').onclick = ()=>cont.scrollBy({ left:-150, behavior:'smooth' });
    document.querySelector('.nav-arrow.right').onclick = ()=>cont.scrollBy({ left:150, behavior:'smooth' });

    headerBackBtn.onclick = ()=>{ document.getElementById('services-carousel').style.display='none'; hideBackBtn(); stepCta.style.display='flex'; };
    document.querySelectorAll('.service-card').forEach(card=> card.onclick=()=>{ const svc = card.dataset.service; document.getElementById('services-carousel').style.display='none'; hideBackBtn(); addMessage(svc,'user'); showTyping(); sendMessage(); });
  </script>
</body>
</html>
