<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Julie - Serial Chilleuse</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%; background: #f2f2f7;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
    }
    body { display: flex; flex-direction: column; }

    /* Overlay de sÃ©lection de langue */
    .language-selection {
      position: fixed; inset: 0;
      background: rgba(96, 192, 230, 0.95);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 10; text-align: center; color: #fff;
      padding: 20px;
    }
    .language-selection p { font-size: 18px; margin-bottom: 16px; }
    .language-selection button {
      margin: 4px; padding: 8px 16px;
      font-size: 14px; border: none; border-radius: 8px;
      cursor: pointer; background: #7f5af0; color: #fff;
      transition: background 0.2s;
    }
    .language-selection button:hover { background: #6248c2; }

    /* Chat UI */
    .chat-header {
      background: #7f5af0; color: #fff;
      padding: 16px; text-align: center;
      font-size: 18px; font-weight: bold;
      flex-shrink: 0;
    }
    .chat-scroll {
      flex: 1; overflow-y: auto;
      padding: 12px; display: flex;
      flex-direction: column; gap: 10px;
    }
    .message-wrapper { display: flex; align-items: flex-end; gap: 8px; }
    .message {
      max-width: 75%; padding: 10px 14px;
      border-radius: 18px; font-size: 14px; line-height: 1.4;
      word-break: break-word; animation: fadeIn 0.2s ease-in;
    }
    .user {
      background: #007aff; color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      border-top-left-radius: 18px;
    }
    .bot {
      background: #e5e5ea; color: #000;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      border-top-right-radius: 18px;
    }
    .bot-pic {
      width: 32px; height: 32px;
      border-radius: 50%; object-fit: cover;
    }
    .input-area {
      background: #fff; padding: 10px;
      border-top: 1px solid #ccc;
      display: flex; align-items: center;
      flex-shrink: 0;
    }
    .input-area input {
      flex: 1; padding: 10px 14px;
      border: 1px solid #ccc; border-radius: 20px;
      font-size: 16px; outline: none;
    }
    .input-area button {
      background: #7f5af0; border: none;
      border-radius: 50%; width: 40px; height: 40px;
      margin-left: 8px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .input-area button svg { fill: #fff; width: 24px; height: 24px; }
    .typing { font-style: italic; font-size: 13px; color: #999; margin-left: 8px; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <!-- Overlay de sÃ©lection de langue -->
  <div class="language-selection" id="language-selection">
    <p>Choisissez votre langue</p>
    <button class="lang-btn" data-lang="fr">FranÃ§ais</button>
    <button class="lang-btn" data-lang="en">English</button>
    <button class="lang-btn" data-lang="es">EspaÃ±ol</button>
    <button class="lang-btn" data-lang="de">Deutsch</button>
  </div>

  <!-- Chat UI plein Ã©cran -->
  <div class="chat-header">ðŸ’¬ Julie - Serial Chilleuse</div>
  <div class="chat-scroll" id="chat"></div>
  <div class="input-area">
    <input type="text" id="user-input" placeholder="Ã‰cris ton message ici...">
    <button onclick="sendMessage()">
      <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3v7l15 2-15 2z"/></svg>
    </button>
  </div>

  <script>
    // Lien dynamique Google Maps
    function generateMapLink(text) {
      const regex = /situÃ©(?:s)? au ([^\.]+)/i;
      const match = regex.exec(text);
      if (match && match[1]) {
        const address = encodeURIComponent(match[1].trim());
        return `<a href="https://maps.google.com/?q=${address}" target="_blank">c'est par ici</a>`;
      }
      return `<a href="https://maps.google.com" target="_blank">c'est par ici</a>`;
    }

    // Transformation des URLs et liens personnalisÃ©s
    function linkify(text) {
      if (text.includes("c'est par ici")) {
        text = text.replace("c'est par ici", generateMapLink(text));
      }
      const urlPattern = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
      return text.replace(urlPattern, '<a href="$1" target="_blank">$1</a>');
    }

    // Gestion multilingue
    let selectedLanguage = 'fr';
    const languageTexts = {
      fr: { welcome: "Salut, je m'appelle Julie, comment puis-je t'aider aujourd'hui ?", typing: "Julie est en train de rÃ©pondre...", placeholder: "Ã‰cris ton message ici..." },
      en: { welcome: "Hi, my name is Julie. How can I help you today?", typing: "Julie is typing...", placeholder: "Type your message here..." },
      es: { welcome: "Hola, me llamo Julie. Â¿CÃ³mo puedo ayudarte hoy?", typing: "Julie estÃ¡ respondiendo...", placeholder: "Escribe tu mensaje aquÃ­..." },
      de: { welcome: "Hallo, ich heiÃŸe Julie. Wie kann ich dir heute helfen?", typing: "Julie antwortet gerade...", placeholder: "Schreib deine Nachricht hier..." }
    };
    function updatePlaceholder() {
      document.getElementById('user-input').placeholder = languageTexts[selectedLanguage].placeholder;
    }

    // Ajout de message dans le chat
    function addMessage(content, sender) {
      const cleanContent = content.replace(/\*\*/g, '').replace(/\n+/g, ' ');
      const formatted = linkify(cleanContent);
      const wrapper = document.createElement('div'); wrapper.className = 'message-wrapper';
      if (sender === 'bot') {
        const avatar = document.createElement('img'); avatar.src='image.png'; avatar.alt='Julie'; avatar.className='bot-pic'; wrapper.appendChild(avatar);
      }
      const msg = document.createElement('div'); msg.className = `message ${sender}`; msg.innerHTML = formatted;
      wrapper.appendChild(msg); document.getElementById('chat').appendChild(wrapper);
      document.querySelector('.chat-scroll').scrollTop = document.querySelector('.chat-scroll').scrollHeight;
    }

    // Effet de saisie
    function showTyping() {
      const t = document.createElement('div'); t.className='typing'; t.id='typing'; t.textContent=languageTexts[selectedLanguage].typing;
      document.getElementById('chat').appendChild(t);
      document.querySelector('.chat-scroll').scrollTop = document.querySelector('.chat-scroll').scrollHeight;
    }
    function removeTyping() { const t=document.getElementById('typing'); if(t) t.remove(); }

    // Envoi du message Ã  l'API
    function sendMessage() {
      const input = document.getElementById('user-input'); const message = input.value.trim(); if(!message) return;
      addMessage(message,'user'); input.value=''; showTyping();
      fetch('https://c842-2001-861-2cab-2ce0-70c5-b21f-76d2-20c5.ngrok-free.app/webhook/30e22add-d5d7-461e-ac07-fc95a3843338',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ message, sessionId:localStorage.getItem('chatSession'), language:selectedLanguage })
      })
      .then(r=>r.json()).then(data=>{ removeTyping(); addMessage(data.response||(data[0]&&data[0].output)||data.message||"Je n'ai pas compris ðŸ˜…",'bot'); })
      .catch(err=>{ removeTyping(); addMessage("Erreur de connexion ðŸ˜“",'bot'); console.error(err); });
    }

    // Initialisation session et Ã©couteurs
    const sessionId = localStorage.getItem('chatSession') || crypto.randomUUID(); localStorage.setItem('chatSession', sessionId);
    document.getElementById('user-input').addEventListener('keydown',e=>{ if(e.key==='Enter') sendMessage(); });
    // SÃ©lection de langue puis affichage des options
    document.querySelectorAll('.lang-btn').forEach(btn=>btn.addEventListener('click',function(){
      selectedLanguage=this.dataset.lang;
      document.getElementById('language-selection').style.display='none';
      updatePlaceholder();
      addMessage(languageTexts[selectedLanguage].welcome,'bot');
      setTimeout(()=>{
        const options=["Les services de mon hÃ´tel","Le livret d'accueil de ma chambre","OÃ¹ chiller ?"];
        const container=document.createElement('div');
        container.style.display='flex';container.style.flexDirection='column';container.style.alignItems='flex-start';container.style.marginTop='10px';container.style.gap='8px';
        options.forEach(opt=>{
          const b=document.createElement('button');b.textContent=opt;
          Object.assign(b.style,{padding:'10px 16px',border:'none',borderRadius:'20px',background:'#7f5af0',color:'#fff',cursor:'pointer',fontSize:'14px'});
          b.onclick=()=>{container.remove(); document.getElementById('chat').appendChild(container); addMessage(opt,'user'); showTyping(); fetch('https://c842-2001-861-2cab-2ce0-70c5-b21f-76d2-20c5.ngrok-free.app/webhook/30e22add-d5d7-461e-ac07-fc95a3843338',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:opt,sessionId:localStorage.getItem('chatSession'),language:selectedLanguage})}).then(r=>r.json()).then(data=>{removeTyping(); addMessage(data.response||(data[0]&&data[0].output)||data.message||"Je n'ai pas compris ðŸ˜…",'bot');}).catch(err=>{removeTyping(); addMessage("Erreur de connexion ðŸ˜“",'bot'); console.error(err);});};
          container.appendChild(b);
        });
        document.getElementById('chat').appendChild(container);
        document.querySelector('.chat-scroll').scrollTop=document.querySelector('.chat-scroll').scrollHeight;
      },400);
    }));
  </script>
</body>
</html>
